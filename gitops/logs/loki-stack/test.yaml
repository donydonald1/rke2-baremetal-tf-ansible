loki-stack:
  loki:
    auth_enabled: false

    commonConfig:
      replication_factor: 1

    limitsConfig:
      retention_period: 720h # 30 days
      allow_structured_metadata: true
      split_queries_by_interval: 15m
      volume_enabled: true

    config:
      schema_config:
        configs:
        - from: "2025-04-01"
          store: boltdb-shipper
          object_store: s3
          schema: v11
          index:
            prefix: loki_index_
            period: 24h

      storage_config:
        aws:
          bucketnames: kosmos-observability-sbx-wl-01
          region: us-east-2
          s3forcepathstyle: false
        boltdb_shipper:
          shared_store: s3
          cache_ttl: 24h

      ruler:
        storage:
          type: s3
          s3:
            bucketnames: kosmos-observability-sbx-wl-01
            region: us-east-2
            s3forcepathstyle: true

    serviceAccount:
      create: true
      annotations:
        eks.amazonaws.com/role-arn: arn:aws:iam::682033478562:role/kosmos-observability-sbx-wl-01-s3-role

  promtail:
    enabled: true
    config:
      logLevel: info
      serverPort: 3101
      clients:
      - url: http://{{ .Release.Name }}.{{ .Release.Namespace }}:3100/loki/api/v1/push
        backoff_config:
          min_period: 500ms
          max_period: 5m
          max_retries: 10
        batchwait: 1s
        batchsize: 1048576 # 1MB
        timeout: 10s

      snippets:
        pipelineStages:
        - cri: {}
        - labelallow:
          - "namespace"
          - "app"
          - "pod"
    extraVolumes:
    - name: containerd-logs
      hostPath:
        path: /var/log/pods
        type: ""
    # extraVolumeMounts:
    # - name: containerd-logs
    #   mountPath: /var/log/pods
    #   readOnly: true
