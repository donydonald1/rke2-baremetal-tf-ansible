loki:
  deploymentMode: SimpleScalable

  loki:
    auth_enabled: false

    analytics:
      reporting_enabled: false
    compactor:
      working_directory: /var/loki/compactor/retention
      delete_request_store: s3
      retention_enabled: true

    frontend:
      max_outstanding_per_tenant: 4096

    ingester:
      chunk_encoding: snappy

    commonConfig:
      replication_factor: 2

    limits_config:
      ingestion_burst_size_mb: 128
      ingestion_rate_mb: 64
      max_query_parallelism: 100
      per_stream_rate_limit: 64M
      per_stream_rate_limit_burst: 128M
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      retention_period: 14d
      shard_streams:
        enabled: true
      split_queries_by_interval: 1h

    query_scheduler:
      max_outstanding_requests_per_tenant: 4096

    rulerConfig:
      enable_api: true
      enable_alertmanager_v2: true
      alertmanager_url: http://kube-prometheus-stack-alertmanager.monitoring:9093
      storage:
        type: local
        local:
          directory: /rules
      rule_path: /rules/fake

    # schemaConfig:
    #   configs:
    #   - from: "2024-04-01"
    #     store: tsdb
    #     object_store: s3
    #     schema: v13
    #     index:
    #       prefix: loki_index_
    #       period: 24h

    server:
      log_level: info
      grpc_server_max_recv_msg_size: 8388608
      grpc_server_max_send_msg_size: 8388608
    config:
      schema_config:
        configs:
        - from: "2025-04-01"
          store: boltdb-shipper
          object_store: s3
          schema: v11
          index:
            prefix: loki_index_
            period: 24h

      storage_config:
        aws:
          endpoint: http://minio.minio.svc.cluster.local:9000
          insecure: true
          bucketnames: loki
          access_key_id: <path:secret/data/minio#postgres_user>
          secret_access_key: <path:secret/data/minio#postgres_password>
          s3forcepathstyle: true
        tsdb_shipper:
          active_index_directory: /loki/index
          cache_location: /loki/index_cache
          cache_ttl: 24h
      # ruler:
      #   storage:
      #     type: s3
      #     s3:
      #       bucketnames: kosmos-observability-sbx-wl-01
      #       region: us-east-2
      #       s3forcepathstyle: true

  gateway:
    replicas: 2
    enabled: true
    image:
      registry: ghcr.io
      repository: nginxinc/nginx-unprivileged
      # tag: 1.27.3-alpine
    nginxConfig:
      resolver: "rke2-coredns-rke2-coredns.kube-system.svc.cluster.local valid=30s ipv6=off"
    deploymentStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 50%
        maxSurge: 50%
    topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: loki
          app.kubernetes.io/component: gateway
    ingress:
      enabled: true
      ingressClassName: "nginx"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        cert-manager.io/revision-history-limit: "3"
        external-dns.alpha.kubernetes.io/enabled: "true"
        cert-manager.io/duration: "2160h"
        cert-manager.io/renew-before: "720h"
      hosts:
      - host: "loki.prod.techsecom.io"
        paths:
        - path: /
          pathType: Prefix
      tls:
      - secretName: loki-gateway-tls
        hosts:
        - "loki.prod.techsecom.io"

  write:
    replicas: 3
    persistence:
      size: 10Gi
      storageClass: "nfs-csi"
    tolerations:
    - key: "arm64"
      operator: "Exists"
  read:
    replicas: 2

  backend:
    replicas: 2
    persistence:
      storageClass: "nfs-csi"
    tolerations:
    - key: "arm64"
      operator: "Exists"

  monitoring:
    dashboards:
      annotations:
        grafana_folder: Loki
    rules:
      enabled: false
    serviceMonitor:
      enabled: false
      metricsInstance:
        enabled: false
    selfMonitoring:
      enabled: false
      grafanaAgent:
        installOperator: false

  sidecar:
    image:
      repository: ghcr.io/kiwigrid/k8s-sidecar
    rules:
      searchNamespace: ALL
      folder: /rules/fake

  lokiCanary:
    enabled: false

  test:
    enabled: false
